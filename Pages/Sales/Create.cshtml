@model CreateSaleViewModel
@{
    ViewData["Title"] = "New Sale";
}

<h2>New Sale</h2>

<form asp-action="Create" method="post">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Sale Items</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" id="medicineSearch" class="form-control" placeholder="Search medicines..." />
                    </div>
                    
                    <div id="searchResults" class="mb-3"></div>
                    
                    <div class="table-responsive">
                        <table class="table" id="saleItemsTable">
                            <thead>
                                <tr>
                                    <th>Medicine</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="saleItemsBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end">
                        <h4>Total: $<span id="totalAmount">0.00</span></h4>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Sale Details</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="CustomerId" class="form-label">Customer (Optional)</label>
                        <select asp-for="CustomerId" class="form-control">
                            <option value="">Walk-in Customer</option>
                            @foreach (var customer in Model.Customers)
                            {
                                <option value="@customer.CustomerId">@customer.FullName - @customer.Phone</option>
                            }
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label asp-for="PaymentMethod" class="form-label">Payment Method</label>
                        <select asp-for="PaymentMethod" class="form-control">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Insurance">Insurance</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">Complete Sale</button>
                        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        let saleItems = [];
        let itemCounter = 0;

        $(document).ready(function() {
            $('#medicineSearch').on('input', function() {
                const query = $(this).val();
                if (query.length > 2) {
                    searchMedicines(query);
                } else {
                    $('#searchResults').empty();
                }
            });
        });

        function searchMedicines(query) {
            $.get('/api/medicines', { q: query }, function(data) {
                let html = '<div class="list-group">';
                data.forEach(function(medicine) {
                    html += `<a href="#" class="list-group-item list-group-item-action" onclick="addMedicine(${medicine.medicineId}, '${medicine.genericName}', ${medicine.price}, ${medicine.availableStock})">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${medicine.genericName} (${medicine.brandName})</h6>
                            <small>$${medicine.price.toFixed(2)}</small>
                        </div>
                        <p class="mb-1">${medicine.strength} ${medicine.form}</p>
                        <small>Stock: ${medicine.availableStock}</small>
                    </a>`;
                });
                html += '</div>';
                $('#searchResults').html(html);
            });
        }

        function addMedicine(medicineId, medicineName, price, availableStock) {
            const existingItem = saleItems.find(item => item.medicineId === medicineId);
            
            if (existingItem) {
                if (existingItem.quantity < availableStock) {
                    existingItem.quantity++;
                    updateSaleItemsTable();
                } else {
                    alert('Insufficient stock available');
                }
            } else {
                saleItems.push({
                    medicineId: medicineId,
                    medicineName: medicineName,
                    price: price,
                    quantity: 1,
                    availableStock: availableStock
                });
                updateSaleItemsTable();
            }
            
            $('#searchResults').empty();
            $('#medicineSearch').val('');
        }

        function updateSaleItemsTable() {
            let html = '';
            let total = 0;
            
            saleItems.forEach(function(item, index) {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                
                html += `<tr>
                    <td>${item.medicineName}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>
                        <input type="number" class="form-control" style="width: 80px;" 
                               value="${item.quantity}" min="1" max="${item.availableStock}"
                               onchange="updateQuantity(${index}, this.value)" />
                        <input type="hidden" name="Items[${index}].MedicineId" value="${item.medicineId}" />
                        <input type="hidden" name="Items[${index}].Quantity" value="${item.quantity}" />
                    </td>
                    <td>$${subtotal.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${index})">Remove</button>
                    </td>
                </tr>`;
            });
            
            $('#saleItemsBody').html(html);
            $('#totalAmount').text(total.toFixed(2));
        }

        function updateQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity > 0 && quantity <= saleItems[index].availableStock) {
                saleItems[index].quantity = quantity;
                updateSaleItemsTable();
            }
        }

        function removeItem(index) {
            saleItems.splice(index, 1);
            updateSaleItemsTable();
        }
    </script>
}